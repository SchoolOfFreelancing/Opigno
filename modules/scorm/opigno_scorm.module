<?php

/**
 * @file
 * Opigno SCORM API.
 */

define('OPIGNO_SCORM_DIRECTORY', variable_get('opigno_scorm_directory', variable_get('file_default_scheme', 'public') . '://opigno_scorm_extracted'));

/**
 * Save a SCORM package information.
 *
 * @param object $scorm
 *
 * @return bool
 */
function opigno_scorm_scorm_save($scorm) {
  if (!empty($scorm->id)) {
    return db_update('opigno_scorm_packages')
      ->fields((array) $scorm)
      ->condition('id', $scorm->id)
      ->execute();
  }
  else {
    $id = db_insert('opigno_scorm_packages')
      ->fields((array) $scorm)
      ->execute();

    $scorm->id = $id;

    return !!$id;
  }
}

/**
 * Load a SCORM package information.
 *
 * @param int $id
 *
 * @return object|false
 */
function opigno_scorm_scorm_load($id) {
  return db_select('opigno_scorm_packages', 'o')
    ->fields('o', array())
    ->condition('id', $id)
    ->execute()
    ->fetchObject();
}

/**
 * Load SCORM package information by file ID.
 *
 * @param int $fid
 *
 * @return object|false
 */
function opigno_scorm_scorm_load_by_fid($fid) {
  return db_select('opigno_scorm_packages', 'o')
    ->fields('o', array())
    ->condition('fid', $fid)
    ->execute()
    ->fetchObject();
}

/**
 * Delete a SCORM package information.
 *
 * @todo Delete all SCOs as well.
 *
 * @param object $scorm
 */
function opigno_scorm_scorm_delete($scorm) {
  db_delete('opigno_scorm_packages')
    ->condition('id', $scorm->id)
    ->execute();
}

/**
 * Save a SCO information.
 *
 * @param object $sco
 *
 * @return bool
 */
function opigno_scorm_sco_save($sco) {
  if (!empty($sco->id)) {
    return db_update('opigno_scorm_package_scos')
      ->fields((array) $sco)
      ->condition('id', $sco->id)
      ->execute();
  }
  else {
    $id = db_insert('opigno_scorm_package_scos')
      ->fields((array) $sco)
      ->execute();

    $sco->id = $id;

    return !!$id;
  }
}

/**
 * Load a SCO information.
 *
 * @param int $id
 *
 * @return object|false
 */
function opigno_scorm_sco_load($id) {
  return db_select('opigno_scorm_package_scos', 'o')
    ->fields('o', array())
    ->condition('id', $id)
    ->execute()
    ->fetchObject();
}

/**
 * Load a SCO information by SCORM id.
 *
 * @param int $scorm_id
 *
 * @return object|false
 */
function opigno_scorm_sco_load_by_scorm_id($scorm_id) {
  return db_select('opigno_scorm_package_scos', 'o')
    ->fields('o', array())
    ->condition('scorm_id', $scorm_id)
    ->execute()
    ->fetchObject();
}

/**
 * Delete a SCO package information.
 *
 * @todo Delete all SCO attributes as well.
 *
 * @param object $sco
 */
function opigno_scorm_sco_delete($sco) {
  db_delete('opigno_scorm_package_scos')
    ->condition('id', $sco->id)
    ->execute();
}
